<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>5.9.&nbsp;Versions</title><link rel="stylesheet" type="text/css" href="../css/freebsd_docbook.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><link rel="home" href="book.html" title="The Apache HBase&#153; Reference Guide"><link rel="up" href="datamodel.html" title="Chapter&nbsp;5.&nbsp;Data Model"><link rel="prev" href="data_model_operations.html" title="5.8.&nbsp;Data Model Operations"><link rel="next" href="dm.sort.html" title="5.10.&nbsp;Sort Order"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.9.&nbsp;Versions</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="data_model_operations.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;5.&nbsp;Data Model</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="dm.sort.html">Next</a></td></tr></table><hr></div><script type="text/javascript">
    var disqus_shortname = 'hbase'; // required: replace example with your forum shortname
    var disqus_url = 'http://hbase.apache.org/book/versions.html';
    </script><div class="section" title="5.9.&nbsp;Versions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="versions"></a>5.9.&nbsp;Versions<a class="indexterm" name="d2875e5895"></a></h2></div></div></div><p>A <span class="emphasis"><em>{row, column, version} </em></span>tuple exactly specifies a
          <code class="literal">cell</code> in HBase. It's possible to have an unbounded number of cells where
        the row and column are the same but the cell address differs only in its version
        dimension.</p><p>While rows and column keys are expressed as bytes, the version is specified using a long
        integer. Typically this long contains time instances such as those returned by
          <code class="code">java.util.Date.getTime()</code> or <code class="code">System.currentTimeMillis()</code>, that is:
          <span class="quote">&#8220;<span class="quote">the difference, measured in milliseconds, between the current time and midnight,
          January 1, 1970 UTC</span>&#8221;</span>.</p><p>The HBase version dimension is stored in decreasing order, so that when reading from a
        store file, the most recent values are found first.</p><p>There is a lot of confusion over the semantics of <code class="literal">cell</code> versions, in
        HBase. In particular:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>If multiple writes to a cell have the same version, only the last written is
            fetchable.</p></li><li class="listitem"><p>It is OK to write cells in a non-increasing version order.</p></li></ul></div><p>Below we describe how the version dimension in HBase currently works. See <a class="link" href="https://issues.apache.org/jira/browse/HBASE-2406" target="_top">HBASE-2406</a> for
            discussion of HBase versions. <a class="link" href="http://outerthought.org/blog/417-ot.html" target="_top">Bending time in HBase</a>
            makes for a good read on the version, or time, dimension in HBase. It has more detail on
            versioning than is provided here. As of this writing, the limiitation
              <span class="emphasis"><em>Overwriting values at existing timestamps</em></span> mentioned in the
            article no longer holds in HBase. This section is basically a synopsis of this article
            by Bruno Dumon.</p><div class="section" title="5.9.1.&nbsp;Specifying the Number of Versions to Store"><div class="titlepage"><div><div><h3 class="title"><a name="specify.number.of.versions"></a>5.9.1.&nbsp;Specifying the Number of Versions to Store</h3></div></div></div><p>The maximum number of versions to store for a given column is part of the column
          schema and is specified at table creation, or via an <span class="command"><strong>alter</strong></span> command, via
            <code class="code">HColumnDescriptor.DEFAULT_VERSIONS</code>. Prior to HBase 0.96, the default number
          of versions kept was <code class="literal">3</code>, but in 0.96 and newer has been changed to
            <code class="literal">1</code>.</p><div class="example"><a name="d2875e5959"></a><p class="title"><b>Example&nbsp;5.3.&nbsp;Modify the Maximum Number of Versions for a Column</b></p><div class="example-contents"><p>This example uses HBase Shell to keep a maximum of 5 versions of column
              <code class="code">f1</code>. You could also use <a class="link" href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/HColumnDescriptor.html" target="_top">HColumnDescriptor</a>.</p><pre class="screen">hbase&gt; alter &#8216;t1&#8242;, NAME =&gt; &#8216;f1&#8242;, VERSIONS =&gt; 5</pre></div></div><br class="example-break"><div class="example"><a name="d2875e5972"></a><p class="title"><b>Example&nbsp;5.4.&nbsp;Modify the Minimum Number of Versions for a Column</b></p><div class="example-contents"><p>You can also specify the minimum number of versions to store. By default, this is
            set to 0, which means the feature is disabled. The following example sets the minimum
            number of versions on field <code class="code">f1</code> to <code class="literal">2</code>, via HBase Shell.
            You could also use <a class="link" href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/HColumnDescriptor.html" target="_top">HColumnDescriptor</a>.</p><pre class="screen">hbase&gt; alter &#8216;t1&#8242;, NAME =&gt; &#8216;f1&#8242;, MIN_VERSIONS =&gt; 2</pre></div></div><br class="example-break"><p>Starting with HBase 0.98.2, you can specify a global default for the maximum number of
          versions kept for all newly-created columns, by setting
            <code class="option">hbase.column.max.version</code> in <code class="filename">hbase-site.xml</code>. See
            <a class="xref" href="config.files.html#hbase.column.max.version" title="hbase.column.max.version"><code class="varname">hbase.column.max.version</code></a>.</p></div><div class="section" title="5.9.2.&nbsp;Versions and HBase Operations"><div class="titlepage"><div><div><h3 class="title"><a name="versions.ops"></a>5.9.2.&nbsp;Versions and HBase Operations</h3></div></div></div><p>In this section we look at the behavior of the version dimension for each of the core
          HBase operations.</p><div class="section" title="5.9.2.1.&nbsp;Get/Scan"><div class="titlepage"><div><div><h4 class="title"><a name="d2875e6003"></a>5.9.2.1.&nbsp;Get/Scan</h4></div></div></div><p>Gets are implemented on top of Scans. The below discussion of <a class="link" href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Get.html" target="_top">Get</a>
            applies equally to <a class="link" href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Scan.html" target="_top">Scans</a>.</p><p>By default, i.e. if you specify no explicit version, when doing a
              <code class="literal">get</code>, the cell whose version has the largest value is returned
            (which may or may not be the latest one written, see later). The default behavior can be
            modified in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>to return more than one version, see <a class="link" href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Get.html#setMaxVersions()" target="_top">Get.setMaxVersions()</a></p></li><li class="listitem"><p>to return versions other than the latest, see <a class="link" href="???" target="_top">Get.setTimeRange()</a></p><p>To retrieve the latest version that is less than or equal to a given value, thus
                giving the 'latest' state of the record at a certain point in time, just use a range
                from 0 to the desired version and set the max versions to 1.</p></li></ul></div></div><div class="section" title="5.9.2.2.&nbsp;Default Get Example"><div class="titlepage"><div><div><h4 class="title"><a name="default_get_example"></a>5.9.2.2.&nbsp;Default Get Example</h4></div></div></div><p>The following Get will only retrieve the current version of the row</p><pre class="programlisting">
public static final byte[] CF = "cf".getBytes();
public static final byte[] ATTR = "attr".getBytes();
...
Get get = new Get(Bytes.toBytes("row1"));
Result r = htable.get(get);
byte[] b = r.getValue(CF, ATTR);  // returns current version of value
</pre></div><div class="section" title="5.9.2.3.&nbsp;Versioned Get Example"><div class="titlepage"><div><div><h4 class="title"><a name="versioned_get_example"></a>5.9.2.3.&nbsp;Versioned Get Example</h4></div></div></div><p>The following Get will return the last 3 versions of the row.</p><pre class="programlisting">
public static final byte[] CF = "cf".getBytes();
public static final byte[] ATTR = "attr".getBytes();
...
Get get = new Get(Bytes.toBytes("row1"));
get.setMaxVersions(3);  // will return last 3 versions of row
Result r = htable.get(get);
byte[] b = r.getValue(CF, ATTR);  // returns current version of value
List&lt;KeyValue&gt; kv = r.getColumn(CF, ATTR);  // returns all versions of this column
</pre></div><div class="section" title="5.9.2.4.&nbsp;Put"><div class="titlepage"><div><div><h4 class="title"><a name="d2875e6046"></a>5.9.2.4.&nbsp;Put</h4></div></div></div><p>Doing a put always creates a new version of a <code class="literal">cell</code>, at a certain
            timestamp. By default the system uses the server's <code class="literal">currentTimeMillis</code>,
            but you can specify the version (= the long integer) yourself, on a per-column level.
            This means you could assign a time in the past or the future, or use the long value for
            non-time purposes.</p><p>To overwrite an existing value, do a put at exactly the same row, column, and
            version as that of the cell you would overshadow.</p><div class="section" title="5.9.2.4.1.&nbsp;Implicit Version Example"><div class="titlepage"><div><div><h5 class="title"><a name="implicit_version_example"></a>5.9.2.4.1.&nbsp;Implicit Version Example</h5></div></div></div><p>The following Put will be implicitly versioned by HBase with the current
              time.</p><pre class="programlisting">
public static final byte[] CF = "cf".getBytes();
public static final byte[] ATTR = "attr".getBytes();
...
Put put = new Put(Bytes.toBytes(row));
put.add(CF, ATTR, Bytes.toBytes( data));
htable.put(put);
</pre></div><div class="section" title="5.9.2.4.2.&nbsp;Explicit Version Example"><div class="titlepage"><div><div><h5 class="title"><a name="explicit_version_example"></a>5.9.2.4.2.&nbsp;Explicit Version Example</h5></div></div></div><p>The following Put has the version timestamp explicitly set.</p><pre class="programlisting">
public static final byte[] CF = "cf".getBytes();
public static final byte[] ATTR = "attr".getBytes();
...
Put put = new Put( Bytes.toBytes(row));
long explicitTimeInMs = 555;  // just an example
put.add(CF, ATTR, explicitTimeInMs, Bytes.toBytes(data));
htable.put(put);
</pre><p>Caution: the version timestamp is internally by HBase for things like time-to-live
              calculations. It's usually best to avoid setting this timestamp yourself. Prefer using
              a separate timestamp attribute of the row, or have the timestamp a part of the rowkey,
              or both. </p></div></div><div class="section" title="5.9.2.5.&nbsp;Delete"><div class="titlepage"><div><div><h4 class="title"><a name="version.delete"></a>5.9.2.5.&nbsp;Delete</h4></div></div></div><p>There are three different types of internal delete markers. See Lars Hofhansl's blog
            for discussion of his attempt adding another, <a class="link" href="http://hadoop-hbase.blogspot.com/2012/01/scanning-in-hbase.html" target="_top">Scanning
              in HBase: Prefix Delete Marker</a>. </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Delete: for a specific version of a column.</p></li><li class="listitem"><p>Delete column: for all versions of a column.</p></li><li class="listitem"><p>Delete family: for all columns of a particular ColumnFamily</p></li></ul></div><p>When deleting an entire row, HBase will internally create a tombstone for each
            ColumnFamily (i.e., not each individual column). </p><p>Deletes work by creating <span class="emphasis"><em>tombstone</em></span> markers. For example, let's
            suppose we want to delete a row. For this you can specify a version, or else by default
            the <code class="literal">currentTimeMillis</code> is used. What this means is <span class="quote">&#8220;<span class="quote">delete all
              cells where the version is less than or equal to this version</span>&#8221;</span>. HBase never
            modifies data in place, so for example a delete will not immediately delete (or mark as
            deleted) the entries in the storage file that correspond to the delete condition.
            Rather, a so-called <span class="emphasis"><em>tombstone</em></span> is written, which will mask the
            deleted values. When HBase does a major compaction, the tombstones are processed to
            actually remove the dead values, together with the tombstones themselves. If the version
            you specified when deleting a row is larger than the version of any value in the row,
            then you can consider the complete row to be deleted.</p><p>For an informative discussion on how deletes and versioning interact, see the thread <a class="link" href="http://comments.gmane.org/gmane.comp.java.hadoop.hbase.user/28421" target="_top">Put w/
              timestamp -&gt; Deleteall -&gt; Put w/ timestamp fails</a> up on the user mailing
            list.</p><p>Also see <a class="xref" href="regions.arch.html#keyvalue" title="9.7.7.6.&nbsp;KeyValue">Section&nbsp;9.7.7.6, &#8220;KeyValue&#8221;</a> for more information on the internal KeyValue format. </p><p>Delete markers are purged during the next major compaction of the store, unless the
              <code class="option">KEEP_DELETED_CELLS</code> option is set in the column family. To keep the
            deletes for a configurable amount of time, you can set the delete TTL via the
              <code class="option">hbase.hstore.time.to.purge.deletes</code> property in
              <code class="filename">hbase-site.xml</code>. If
              <code class="option">hbase.hstore.time.to.purge.deletes</code> is not set, or set to 0, all
            delete markers, including those with timestamps in the future, are purged during the
            next major compaction. Otherwise, a delete marker with a timestamp in the future is kept
            until the major compaction which occurs after the time represented by the marker's
            timestamp plus the value of <code class="option">hbase.hstore.time.to.purge.deletes</code>, in
            milliseconds. </p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This behavior represents a fix for an unexpected change that was introduced in
              HBase 0.94, and was fixed in <a class="link" href="https://issues.apache.org/jira/browse/HBASE-10118" target="_top">HBASE-10118</a>.
              The change has been backported to HBase 0.94 and newer branches.</p></div></div></div><div class="section" title="5.9.3.&nbsp;Current Limitations"><div class="titlepage"><div><div><h3 class="title"><a name="d2875e6141"></a>5.9.3.&nbsp;Current Limitations</h3></div></div></div><div class="section" title="5.9.3.1.&nbsp;Deletes mask Puts"><div class="titlepage"><div><div><h4 class="title"><a name="d2875e6144"></a>5.9.3.1.&nbsp;Deletes mask Puts</h4></div></div></div><p>Deletes mask puts, even puts that happened after the delete
          was entered. See <a class="link" href="https://issues.apache.org/jira/browse/HBASE-2256" target="_top">HBASE-2256</a>. Remember that a delete writes a tombstone, which only
          disappears after then next major compaction has run. Suppose you do
          a delete of everything &lt;= T. After this you do a new put with a
          timestamp &lt;= T. This put, even if it happened after the delete,
          will be masked by the delete tombstone. Performing the put will not
          fail, but when you do a get you will notice the put did have no
          effect. It will start working again after the major compaction has
          run. These issues should not be a problem if you use
          always-increasing versions for new puts to a row. But they can occur
          even if you do not care about time: just do delete and put
          immediately after each other, and there is some chance they happen
          within the same millisecond.</p></div><div class="section" title="5.9.3.2.&nbsp;Major compactions change query results"><div class="titlepage"><div><div><h4 class="title"><a name="major.compactions.change.query.results"></a>5.9.3.2.&nbsp;Major compactions change query results</h4></div></div></div><p><span class="quote">&#8220;<span class="quote">...create three cell versions at t1, t2 and t3, with a maximum-versions
              setting of 2. So when getting all versions, only the values at t2 and t3 will be
              returned. But if you delete the version at t2 or t3, the one at t1 will appear again.
              Obviously, once a major compaction has run, such behavior will not be the case
              anymore...</span>&#8221;</span> (See <span class="emphasis"><em>Garbage Collection</em></span> in <a class="link" href="http://outerthought.org/blog/417-ot.html" target="_top">Bending time in
            HBase</a>.)</p></div></div></div><div id="disqus_thread"></div><script type="text/javascript">
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="data_model_operations.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="datamodel.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="dm.sort.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.8.&nbsp;Data Model Operations&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="book.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;5.10.&nbsp;Sort Order</td></tr></table></div></body></html>